name: Notify Discord on Push

on:
  push:
    branches:
      - main      # ← Change to "master" if that’s your default branch
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Dump entire event for debugging
        run: |
          echo "GITHUB EVENT:"
          echo "${{ toJson(github.event) }}"

      - name: Send Discord notification
        uses: actions/github-script@v6
        with:
          script: |
            // Only fire on real pushes
            if (!github.event.head_commit) {
              console.log("⚠️ No head_commit, skipping Discord post.");
              return;
            }

            const commit = github.event.head_commit;
            const repo   = github.event.repository.full_name;
            const msg = `📝 **${repo}** pushed by **${commit.author.name}**:\n> ${commit.message}\n${commit.url}`;
            console.log("✅ Posting to Discord:", msg);

            await fetch(process.env.DISCORD_WEBHOOK, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ content: msg })
            });
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
