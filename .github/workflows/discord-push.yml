name: Notify Discord on Push

on:
  push:
    branches:
      - main    # or master if thatâ€™s your default
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Dump entire event for debugging
        run: |
          echo "GITHUB EVENT:"
          echo "${{ toJson(github.context.payload) }}"

      - name: Send Discord notification
        uses: actions/github-script@v6
        with:
          script: |
            const payload = github.context.payload;
            if (!payload.head_commit) {
              console.log("âš ï¸ No head_commit, skipping Discord post.");
              return;
            }

            const commit = payload.head_commit;
            const repo   = payload.repository.full_name;
            const msg = `ðŸ“ **${repo}** pushed by **${commit.author.name}**:\n> ${commit.message}\n${commit.url}`;
            console.log("âœ… Posting to Discord:", msg);

            await fetch(process.env.DISCORD_WEBHOOK, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ content: msg })
            });
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
